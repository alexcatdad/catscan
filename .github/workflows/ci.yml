name: CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  lint-go:
    name: Lint Go
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4@692973e3d937129bcbf40652eb9f2f61becf3332

      - name: Setup Go
        uses: actions/setup-go@v5@0a12ed9d6a96ab950c8f026e966a672a1dd7fbd9
        with:
          go-version: "1.25"
          cache: false

      - name: Install golangci-lint
        run: curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b $(go env GOPATH)/bin v1.62.2

      - name: Run golangci-lint
        run: $(go env GOPATH)/bin/golangci-lint run ./...

  lint-frontend:
    name: Lint Frontend
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4@692973e3d937129bcbf40652eb9f2f61becf3332

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2@00923f47074cbcfe7193e0e56cdfb69d0fcc044b
        with:
          bun-version: "1.3.9"

      - name: Install dependencies
        working-directory: ./frontend
        run: bun install --frozen-lockfile

      - name: Run Biome check
        working-directory: ./frontend
        run: bunx biome check

      - name: Run svelte-check
        working-directory: ./frontend
        run: bun run check

  test-go:
    name: Test Go
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4@692973e3d937129bcbf40652eb9f2f61becf3332

      - name: Setup Go
        uses: actions/setup-go@v5@0a12ed9d6a96ab950c8f026e966a672a1dd7fbd9
        with:
          go-version: "1.25"
          cache: false

      - name: Run tests
        run: go test -v -race ./...

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [lint-go, lint-frontend, test-go]
    steps:
      - name: Checkout
        uses: actions/checkout@v4@692973e3d937129bcbf40652eb9f2f61becf3332

      - name: Setup Go
        uses: actions/setup-go@v5@0a12ed9d6a96ab950c8f026e966a672a1dd7fbd9
        with:
          go-version: "1.25"
          cache: false

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2@00923f47074cbcfe7193e0e56cdfb69d0fcc044b
        with:
          bun-version: "1.3.9"

      - name: Install frontend dependencies
        working-directory: ./frontend
        run: bun install --frozen-lockfile

      - name: Build Svelte frontend
        working-directory: ./frontend
        run: bun run build

      - name: Build Go binary
        run: go build -o ./bin/catscan ./cmd/catscan

      - name: Verify build artifacts
        run: |
          test -f ./dist/index.html
          test -f ./bin/catscan
